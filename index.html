<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹æŠ½ç - ç°¡å ±å½©è›‹</title>
    <!-- å¼•å…¥ Tailwind CSS æ–¹ä¾¿æ’ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Canvas Confetti ç…™ç«ç‰¹æ•ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* å¯¶ç®±éœ‡å‹•å‹•ç•« */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake-animation {
            animation: shake 0.5s;
            animation-iteration-count: infinite;
        }

        /* å¾½ç« æµ®ç¾å‹•ç•« */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            80% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .badge-pop {
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* èƒŒæ™¯å¾®å…‰æµå‹• */
        .bg-gradient-animate {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ç¦ç”¨ç‹€æ…‹æ¨£å¼ */
        .disabled-box {
            filter: grayscale(100%);
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gradient-animate h-screen w-screen flex flex-col items-center justify-center text-white overflow-hidden font-sans">

<!-- ç‹€æ…‹ 1: å¾…æ©Ÿç•«é¢ -->
<div id="state-ready" class="text-center transition-all duration-500 w-full max-w-md px-4">
    <h1 class="text-3xl font-bold mb-4 drop-shadow-md">âœ¨ ç°¡å ±çµå°¾å½©è›‹ âœ¨</h1>

    <!-- æ¬¡æ•¸é¡¯ç¤º -->
    <div class="mb-6">
            <span id="attempts-badge" class="bg-white/20 px-4 py-1 rounded-full text-sm font-bold backdrop-blur-sm border border-white/30">
                å‰©é¤˜æ¬¡æ•¸: <span id="attempts-count" class="text-yellow-300 text-lg">3</span>
            </span>
    </div>

    <div id="gift-box" class="cursor-pointer group relative inline-block" onclick="startDraw()">
        <!-- å¯¶ç®± Emoji -->
        <div id="gift-icon" class="text-9xl transition-transform transform group-hover:scale-110 drop-shadow-2xl">
            ğŸ
        </div>
        <p id="click-hint" class="mt-8 text-xl animate-bounce bg-white/20 px-6 py-2 rounded-full backdrop-blur-sm">
            é»æ“Šé–‹å•Ÿ
        </p>
    </div>

    <p id="status-msg" class="mt-12 text-sm opacity-70">çœ‹çœ‹ä½ æ˜¯ä¸æ˜¯é‚£ 10% çš„å¹¸é‹å…’...</p>
</div>

<!-- ç‹€æ…‹ 2: æŠ½çä¸­ (éœ‡å‹•) -->
<div id="state-drawing" class="hidden text-center">
    <div class="text-9xl shake-animation mb-4">
        ğŸ
    </div>
    <p class="text-2xl font-bold tracking-widest">ç¥ˆç¦±ä¸­...</p>
</div>

<!-- ç‹€æ…‹ 3: çµæœé¡¯ç¤º -->
<div id="state-result" class="hidden text-center px-4 w-full max-w-md">

    <!-- çµæœå®¹å™¨ -->
    <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-8 shadow-2xl relative overflow-hidden">

        <!-- å…‰èŠ’ç‰¹æ•ˆ (åƒ…é™å¤§ç) -->
        <div id="winner-glow" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-yellow-400 rounded-full blur-[100px] opacity-50 z-0"></div>

        <!-- å¾½ç« åœ–ç‰‡/Emoji -->
        <div id="result-icon" class="text-9xl mb-6 relative z-10 badge-pop">
            <!-- JS æœƒå¡«å…¥å…§å®¹ -->
        </div>

        <h2 id="result-title" class="text-3xl font-bold mb-2 relative z-10">
            <!-- JS æœƒå¡«å…¥æ¨™é¡Œ -->
        </h2>

        <p id="result-desc" class="text-lg opacity-90 mb-8 relative z-10">
            <!-- JS æœƒå¡«å…¥æè¿° -->
        </p>

        <!-- æŒ‰éˆ•å€åŸŸ -->
        <div class="relative z-10">
            <button id="retry-btn" onclick="resetToReady()" class="hidden bg-white text-pink-600 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transition-colors">
                å†è©¦ä¸€æ¬¡
            </button>

            <div id="game-over-msg" class="hidden text-gray-200 font-bold bg-black/30 py-2 px-4 rounded-lg">
                æŠ½çæ¬¡æ•¸å·²ç”¨å®Œ ğŸ˜­
            </div>
        </div>
    </div>

    <div id="winner-instruction" class="hidden mt-6 bg-black/40 p-4 rounded-lg animate-pulse border border-yellow-400/50 text-yellow-300 font-bold">
        ğŸš¨ è«‹ç¾åœ¨èˆ‰æ‰‹é ˜çï¼
    </div>
</div>

<script>
    // ================= é…ç½®å€åŸŸ =================

    const PRIZES = {
        winner: {
            id: 'rare',
            icon: 'ğŸ†', // åœ–ç‰‡è«‹æ”¹é€™è£¡: '<img src="rare.png" class="w-48 h-48 object-contain mx-auto">'
            title: 'æ­å–œä¸­çï¼',
            desc: 'ä½ æ˜¯è¢«é¸ä¸­çš„å¤©é¸ä¹‹äººï¼',
            isJackpot: true
        },
        participant: {
            id: 'common',
            icon: 'ğŸ…', // åœ–ç‰‡è«‹æ”¹é€™è£¡: '<img src="common.png" class="w-40 h-40 object-contain mx-auto">'
            title: 'æ„Ÿè¬åƒèˆ‡',
            desc: 'é€™æ¬¡é‹æ°£å·®äº†ä¸€é»é»...',
            isJackpot: false
        }
    };

    const WIN_RATE = 0.1; // 10% æ©Ÿç‡
    const MAX_ATTEMPTS = 3; // æœ€å¤§å˜—è©¦æ¬¡æ•¸

    // ================= é‚è¼¯å€åŸŸ =================

    // è®€å– LocalStorage è³‡æ–™
    let attemptsLeft = parseInt(localStorage.getItem('lucky_draw_attempts_v1')) || 0;
    let hasWon = localStorage.getItem('lucky_draw_won_v1') === 'true';

    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä¾†(æ²’æœ‰ç´€éŒ„)ï¼Œåˆå§‹åŒ–ç‚ºæœ€å¤§æ¬¡æ•¸
    if (localStorage.getItem('lucky_draw_attempts_v1') === null) {
        attemptsLeft = MAX_ATTEMPTS;
        localStorage.setItem('lucky_draw_attempts_v1', attemptsLeft);
    }

    // DOM å…ƒç´ 
    const stateReady = document.getElementById('state-ready');
    const stateDrawing = document.getElementById('state-drawing');
    const stateResult = document.getElementById('state-result');

    const giftBox = document.getElementById('gift-box');
    const clickHint = document.getElementById('click-hint');
    const statusMsg = document.getElementById('status-msg');
    const attemptsCountEl = document.getElementById('attempts-count');

    const resultIcon = document.getElementById('result-icon');
    const resultTitle = document.getElementById('result-title');
    const resultDesc = document.getElementById('result-desc');
    const winnerGlow = document.getElementById('winner-glow');
    const winnerInstruction = document.getElementById('winner-instruction');
    const retryBtn = document.getElementById('retry-btn');
    const gameOverMsg = document.getElementById('game-over-msg');

    // åˆå§‹åŒ–ç•«é¢
    updateUI();

    function updateUI() {
        attemptsCountEl.innerText = attemptsLeft;

        // å¦‚æœå·²ç¶“ä¸­éç
        if (hasWon) {
            showWinStateDirectly();
            return;
        }

        // å¦‚æœæ¬¡æ•¸ç”¨å®Œ
        if (attemptsLeft <= 0) {
            disableBox("æ©Ÿæœƒå·²ç”¨ç›¡ï¼Œæ„Ÿè¬åƒèˆ‡ï¼");
        }
    }

    function disableBox(msg) {
        giftBox.classList.add('disabled-box');
        clickHint.classList.add('hidden');
        statusMsg.innerText = msg;
        statusMsg.classList.add('text-yellow-300', 'font-bold', 'text-lg');
    }

    function startDraw() {
        if (attemptsLeft <= 0 || hasWon) return;

        // 1. æ‰£é™¤æ¬¡æ•¸
        attemptsLeft--;
        localStorage.setItem('lucky_draw_attempts_v1', attemptsLeft);
        updateUI();

        // 2. åˆ‡æ›å‹•ç•«
        stateReady.classList.add('hidden');
        stateDrawing.classList.remove('hidden');

        // 3. ç­‰å¾…å‹•ç•«
        setTimeout(() => {
            calculateResult();
        }, 2000);
    }

    function calculateResult() {
        const rand = Math.random();
        // æ¯æ¬¡æŠ½çéƒ½æ˜¯ç¨ç«‹æ©Ÿç‡ï¼Œä½†ä½ å¯ä»¥æ ¹æ“šéœ€æ±‚èª¿æ•´
        const prize = rand < WIN_RATE ? PRIZES.winner : PRIZES.participant;

        // æ¸²æŸ“å…§å®¹
        resultIcon.innerHTML = prize.icon;
        resultTitle.innerText = prize.title;
        resultDesc.innerText = prize.desc;

        stateDrawing.classList.add('hidden');
        stateResult.classList.remove('hidden');

        if (prize.isJackpot) {
            // ä¸­å¤§çé‚è¼¯
            hasWon = true;
            localStorage.setItem('lucky_draw_won_v1', 'true');

            winnerGlow.classList.remove('hidden');
            winnerInstruction.classList.remove('hidden');
            gameOverMsg.classList.add('hidden');
            retryBtn.classList.add('hidden'); // ä¸­çå°±ä¸éœ€è¦é‡è©¦æŒ‰éˆ•äº†

            launchConfetti();
            document.body.style.background = "linear-gradient(-45deg, #FFD700, #FF8C00)";
        } else {
            // æ²’ä¸­çé‚è¼¯
            winnerGlow.classList.add('hidden');
            winnerInstruction.classList.add('hidden');

            if (attemptsLeft > 0) {
                // é‚„èƒ½æŠ½ï¼šé¡¯ç¤ºé‡è©¦æŒ‰éˆ•
                retryBtn.classList.remove('hidden');
                gameOverMsg.classList.add('hidden');
            } else {
                // æ²’æ©Ÿæœƒäº†ï¼šé¡¯ç¤ºçµæŸè¨Šæ¯
                retryBtn.classList.add('hidden');
                gameOverMsg.classList.remove('hidden');
            }
        }
    }

    function resetToReady() {
        // å¾çµæœé è¿”å›é¦–é ï¼Œè€Œä¸æ˜¯åˆ·æ–°é é¢
        stateResult.classList.add('hidden');
        stateReady.classList.remove('hidden');
        updateUI();
    }

    function showWinStateDirectly() {
        // å¦‚æœä¸€é€²ä¾†å°±ç™¼ç¾è´éäº†ï¼Œç›´æ¥é¡¯ç¤ºçµæœé ï¼Œä¸çµ¦æŠ½
        // é€™è£¡ç°¡å–®è™•ç†ï¼šç¦ç”¨é¦–é ï¼Œé¡¯ç¤ºæ–‡å­—
        disableBox("æ‚¨å·²ç¶“ä¸­çå›‰ï¼è«‹èˆ‰æ‰‹é ˜ç ğŸ‰");

        // æˆ–æ˜¯ä¹Ÿå¯ä»¥é¸æ“‡ç›´æ¥è·³åˆ°çµæœé  (è¦–éœ€æ±‚æ‰“é–‹ä¸‹é¢è¨»è§£)
        /*
        stateReady.classList.add('hidden');
        stateResult.classList.remove('hidden');
        resultIcon.innerHTML = PRIZES.winner.icon;
        resultTitle.innerText = PRIZES.winner.title;
        resultDesc.innerText = "æ‚¨ä¹‹å‰å·²ç¶“ä¸­çäº†ï¼";
        winnerInstruction.classList.remove('hidden');
        retryBtn.classList.add('hidden');
        launchConfetti();
        */
    }

    function launchConfetti() {
        var duration = 3 * 1000;
        var animationEnd = Date.now() + duration;
        var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

        var random = function(min, max) {
            return Math.random() * (max - min) + min;
        };

        var interval = setInterval(function() {
            var timeLeft = animationEnd - Date.now();

            if (timeLeft <= 0) {
                return clearInterval(interval);
            }

            var particleCount = 50 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 250);
    }
</script>
</body>
</html>